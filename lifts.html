<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>lifts — will + jolene</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="site-nav">
    <a href="index.html" class="nav-logo">will + jolene</a>
    <button type="button" class="nav-toggle" id="navToggle" aria-label="Toggle menu"><i class="bi bi-list"></i></button>
    <div class="nav-links" id="navLinks">
      <a href="messages.html">messages</a>
      <a href="lifts.html">lifts</a>
      <a href="mood.html">mood</a>
      <a href="photos.html">photos</a>
      <a href="notes.html">notes</a>
      <a href="timeline.html">timeline</a>
      <a href="weather.html">weather</a>
      <a href="distance.html">distance</a>
      <a href="music.html">music</a>
      <a href="qotd.html">question of the day</a>
    </div>
  </nav>

  <main class="main">
    <div class="container container-wide">
      <h1 class="page-title"><i class="bi bi-heart-pulse"></i> lifts</h1>

      <div class="gym-cards">
        <div class="gym-card">
          <img class="gym-logo" src="gyms/urec.png" alt="JMU UREC" onerror="this.style.display='none'">
          <p class="gym-name">JMU UREC</p>
          <p class="gym-who">Will · Harrisonburg</p>
        </div>
        <div class="gym-card">
          <img class="gym-logo" src="gyms/pf.png" alt="Planet Fitness" onerror="this.style.display='none'">
          <p class="gym-name">Planet Fitness</p>
          <p class="gym-who">Jolene · State College</p>
        </div>
      </div>

      <div class="lifts-calendar-wrap">
        <div class="lifts-calendar-header">
          <span class="lifts-calendar-month" id="calendarMonthTitle"></span>
          <div class="lifts-calendar-nav">
            <button type="button" id="calendarPrev" aria-label="Previous month"><i class="bi bi-chevron-left"></i></button>
            <button type="button" id="calendarNext" aria-label="Next month"><i class="bi bi-chevron-right"></i></button>
          </div>
        </div>
        <div class="lifts-calendar-weekdays">
          <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
        </div>
        <div class="lifts-calendar-grid" id="liftsCalendarGrid"></div>
      </div>

      <section class="lifts-log-section">
        <h2>Log workout</h2>
        <div class="log-cards">
          <div class="log-card will">
            <span class="split-label">Will</span>
            <p class="muscle-label">Muscle groups</p>
            <div id="muscleGridWill" class="muscle-grid"></div>
            <button type="button" class="btn btn-will" id="logWill">Log workout</button>
          </div>
          <div class="log-card jolene">
            <span class="split-label">Jolene</span>
            <p class="muscle-label">Muscle groups</p>
            <div id="muscleGridJolene" class="muscle-grid"></div>
            <button type="button" class="btn btn-jolene" id="logJolene">Log workout</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script src="js/shared.js"></script>
  <script>
    var MUSCLES = ['Chest', 'Back', 'Shoulders', 'Biceps', 'Triceps', 'Legs', 'Core'];
    var calendarYear, calendarMonth;
    var liftsByDate = {};

    function buildMuscleGrid(containerId) {
      var grid = document.getElementById(containerId);
      if (!grid) return;
      grid.innerHTML = '';
      MUSCLES.forEach(function(m) {
        var label = document.createElement('label');
        label.className = 'muscle-chip';
        label.innerHTML = '<input type="checkbox" name="m" value="' + m + '"> ' + m;
        label.onclick = function() { var cb = label.querySelector('input'); cb.checked = !cb.checked; label.classList.toggle('selected', cb.checked); };
        grid.appendChild(label);
      });
    }
    buildMuscleGrid('muscleGridWill');
    buildMuscleGrid('muscleGridJolene');

    function getMuscles(containerId) {
      return Array.from(document.querySelectorAll('#' + containerId + ' input:checked')).map(function(c) { return c.value; }).join(', ');
    }
    function clearMuscles(containerId) {
      document.querySelectorAll('#' + containerId + ' input:checked').forEach(function(c) { c.checked = false; });
      document.querySelectorAll('#' + containerId + ' .muscle-chip').forEach(function(l) { l.classList.remove('selected'); });
    }

    function setCalendarMonth(y, m) {
      calendarYear = y;
      calendarMonth = m;
      var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      var title = document.getElementById('calendarMonthTitle');
      if (title) title.textContent = monthNames[m] + ' ' + y;
      renderCalendar();
    }

    function getDaysInMonth(y, m) {
      return new Date(y, m + 1, 0).getDate();
    }
    function getFirstWeekday(y, m) {
      return new Date(y, m, 1).getDay();
    }

    function renderCalendar() {
      var grid = document.getElementById('liftsCalendarGrid');
      if (!grid) return;
      var daysInMonth = getDaysInMonth(calendarYear, calendarMonth);
      var firstDay = getFirstWeekday(calendarYear, calendarMonth);
      var today = new Date();
      var todayKey = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

      grid.innerHTML = '';
      var cells = [];
      var prevMonth = calendarMonth === 0 ? 11 : calendarMonth - 1;
      var prevYear = calendarMonth === 0 ? calendarYear - 1 : calendarYear;
      var prevDays = getDaysInMonth(prevYear, prevMonth);
      for (var i = 0; i < firstDay; i++) {
        var d = prevDays - firstDay + i + 1;
        cells.push({ day: d, other: true, key: prevYear + '-' + String(prevMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0') });
      }
      for (var d = 1; d <= daysInMonth; d++) {
        var key = calendarYear + '-' + String(calendarMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
        cells.push({ day: d, other: false, key: key });
      }
      var remaining = 42 - cells.length;
      for (var n = 1; n <= remaining; n++) {
        cells.push({ day: n, other: true, key: '' });
      }

      cells.forEach(function(cell) {
        var div = document.createElement('div');
        div.className = 'lifts-calendar-day';
        if (cell.other) div.classList.add('other-month');
        if (cell.key === todayKey) div.classList.add('today');

        var num = document.createElement('div');
        num.className = 'lifts-calendar-day-num';
        num.textContent = cell.day;
        div.appendChild(num);

        var entries = liftsByDate[cell.key];
        if (entries && entries.length) {
          entries.forEach(function(entry) {
            var e = document.createElement('div');
            e.className = 'lifts-calendar-day-entry ' + (entry.from_name.toLowerCase().indexOf('will') !== -1 ? 'will' : 'jolene');
            e.textContent = (entry.from_name || '').split(' ')[0] + ': ' + (entry.muscles || '').substring(0, 20) + (entry.muscles && entry.muscles.length > 20 ? '…' : '');
            e.title = entry.muscles || '';
            div.appendChild(e);
          });
        }
        grid.appendChild(div);
      });
    }

    function loadLiftsForCalendar(client) {
      if (!client) return;
      var start = new Date(calendarYear, calendarMonth, 1);
      var end = new Date(calendarYear, calendarMonth + 1, 0);
      var startStr = start.toISOString().slice(0, 10);
      var endStr = end.toISOString().slice(0, 10);
      client.from('lifts').select('from_name, muscles, log_date')
        .gte('log_date', startStr)
        .lte('log_date', endStr)
        .order('log_date', { ascending: true })
        .then(function(r) {
          if (r.error) throw r.error;
          liftsByDate = {};
          (r.data || []).forEach(function(row) {
            var key = row.log_date;
            if (!liftsByDate[key]) liftsByDate[key] = [];
            liftsByDate[key].push(row);
          });
          renderCalendar();
        })
        .catch(function(err) { console.error(err); renderCalendar(); });
    }

    function logLift(from, gridId, btnId) {
      var muscles = getMuscles(gridId);
      if (!muscles) { alert('Pick at least one muscle group.'); return; }
      var btn = document.getElementById(btnId);
      if (btn) { btn.disabled = true; btn.textContent = 'Logging...'; }
      getSupabase(function(client) {
        if (!client) { if (btn) { btn.disabled = false; btn.textContent = 'Log workout'; } return; }
        client.from('lifts').insert([{ from_name: from, muscles: muscles }]).then(function(r) {
          if (r.error) throw r.error;
          clearMuscles(gridId);
          loadLiftsForCalendar(client);
        }).catch(function(err) { alert('Could not save.'); }).finally(function() {
          if (btn) { btn.disabled = false; btn.textContent = 'Log workout'; }
        });
      });
    }

    var now = new Date();
    setCalendarMonth(now.getFullYear(), now.getMonth());

    document.getElementById('calendarPrev').addEventListener('click', function() {
      if (calendarMonth === 0) setCalendarMonth(calendarYear - 1, 11);
      else setCalendarMonth(calendarYear, calendarMonth - 1);
      getSupabase(function(c) { loadLiftsForCalendar(c); });
    });
    document.getElementById('calendarNext').addEventListener('click', function() {
      if (calendarMonth === 11) setCalendarMonth(calendarYear + 1, 0);
      else setCalendarMonth(calendarYear, calendarMonth + 1);
      getSupabase(function(c) { loadLiftsForCalendar(c); });
    });

    getSupabase(function(c) {
      loadLiftsForCalendar(c);
    });
    document.getElementById('logWill').addEventListener('click', function() { logLift('Will', 'muscleGridWill', 'logWill'); });
    document.getElementById('logJolene').addEventListener('click', function() { logLift('Jolene', 'muscleGridJolene', 'logJolene'); });
  </script>
</body>
</html>
